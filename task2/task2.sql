/*
  Follow the steps:
   - create the bank and populate;
   - run the query
   - use the 'DELETE FROM events command;' to clear data about events;
   - repeat the process of populating the database and executing the query;

*/

-- Table creation

CREATE TABLE events (
  event_type integer NOT NULL,
  value integer NOT NULL,
  time timestamp NOT NULL,
  UNIQUE (event_type, time)
);

-- Insert 1

insert into events values
 (2,   5, '2015-05-09 12:42:00'),
 (4, -42, '2015-05-09 13:19:57'),
 (2,   2, '2015-05-09 14:48:30'),
 (2,   7, '2015-05-09 12:54:39'),
 (3,  16, '2015-05-09 13:19:57'),
 (3,  20, '2015-05-09 15:01:09');

DELETE FROM events;

-- Insert 2

insert into events values 
 (2,   5, '2015-05-09 12:42:00'),
 (4, -42, '2015-05-09 13:19:57'),
 (2,   2, '2015-05-09 14:48:30'),
 (2,   7, '2015-05-09 12:54:39'),
 (3,  16, '2015-05-09 13:19:57'),
 (3,  20, '2015-05-09 22:01:09'),
 (3,  16, '2016-05-09 13:19:57'),
 (3,  20, '2015-05-09 01:01:09'),
 (4,   0, '2015-05-09 05:19:57'),
 (4, 1, '2015-05-09 13:18:58'),
 (4,   1, '2016-05-09 12:19:57'),
 (2,   3, '2015-05-09 14:11:30'),
 (2,   2, '2015-05-09 19:54:39');

DELETE FROM events;

-- Insert 3

insert into events values 
 (1,   1,  '2015-05-09 12:42:00'),
 (1, 	2,  '2015-05-09 13:19:57'),
 (2,   3,  '2015-05-09 14:48:30'),
 (2,   4,  '2015-05-09 12:54:39'),
 (3,  	5,  '2015-05-09 13:19:57'),
 (3,  	6,  '2015-05-09 22:01:09'),
 (4,  	7,  '2016-05-09 13:19:57'),
 (4,  	8,  '2015-05-09 01:01:09'),
 (5,   9,  '2015-05-09 05:19:57'),
 (5, 	10, '2015-05-09 13:18:58'),
 (6,   11, '2016-05-09 12:19:57'),
 (6,   12, '2015-05-09 14:11:30'),
 (7,   13, '2015-05-09 14:11:30');

DELETE FROM events;

-- Insert 4

insert into events values 
 (1,   1,  '2015-05-09 01:42:00'),
 (1, 	2,  '2015-05-09 02:19:57'),
 (2,   3,  '2015-05-09 03:48:30'),
 (2,   4,  '2015-05-09 04:54:39'),
 (3,  	5,  '2015-05-09 05:19:57'),
 (3,  	6,  '2015-05-09 06:01:09'),
 (4,  	7,  '2016-05-09 07:19:57'),
 (4,  	8,  '2015-05-09 08:01:09'),
 (5,   9,  '2015-05-09 09:19:57'),
 (5, 	10, '2015-05-09 10:18:58'),
 (6,   11, '2016-05-09 11:19:57'),
 (6,   12, '2015-05-09 12:11:30'),
 (7,   13, '2015-05-09 13:11:30'),
 (1,   1,  '2015-05-09 14:42:00'),
 (1, 	2,  '2015-05-09 15:19:57'),
 (2,   3,  '2015-05-09 16:48:30'),
 (2,   4,  '2015-05-09 17:54:39'),
 (3,  	5,  '2015-05-09 18:19:57'),
 (3,  	6,  '2015-05-09 19:01:09'),
 (4,  	7,  '2016-05-09 20:19:57'),
 (4,  	8,  '2015-05-09 21:01:09'),
 (5,   9,  '2015-05-09 22:19:57'),
 (5, 	10, '2015-05-09 23:18:58'),
 (6,   11, '2016-05-09 23:19:57'),
 (6,   12, '2015-05-09 14:10:31'),
 (7,   13, '2015-05-09 14:20:30'),
 (1,   1,  '2015-05-09 12:30:00'),
 (1, 	2,  '2015-05-09 13:40:57'),
 (2,   3,  '2015-05-09 14:50:30'),
 (2,   4,  '2015-05-09 12:59:01'),
 (3,  	5,  '2015-05-09 13:19:05'),
 (3,  	6,  '2015-05-09 22:01:10'),
 (4,  	7,  '2016-05-09 13:19:15'),
 (4,  	8,  '2015-05-09 01:01:20'),
 (5,   9,  '2015-05-09 05:19:25'),
 (5, 	10, '2015-05-09 13:18:30'),
 (6,   11, '2016-05-09 12:19:35'),
 (6,   12, '2015-05-09 14:11:40'),
 (7,   13, '2015-05-09 14:11:45'),
 (1,   1,  '2015-05-09 12:42:50'),
 (1, 	2,  '2015-05-09 13:19:59'),
 (2,   3,  '2015-05-09 14:01:30'),
 (2,   4,  '2015-05-09 12:02:39'),
 (3,  	5,  '2015-05-09 13:03:57'),
 (3,  	6,  '2015-05-09 22:04:09'),
 (4,  	7,  '2016-05-09 13:05:57'),
 (4,  	8,  '2015-05-09 01:06:09'),
 (5,   9,  '2015-05-09 05:07:57'),
 (5, 	10, '2015-05-09 13:08:58'),
 (6,   11, '2016-05-09 12:09:57'),
 (6,   12, '2015-05-09 14:10:30'),
 (7,   13, '2015-05-09 14:11:30');

DELETE FROM events;

=============================================================================

-- query
SELECT DISTINCT e.event_type, 
    IF((SELECT COUNT(*) FROM events e2 WHERE e2.event_type = e.event_type) = 2, 0,
        (SELECT e2.value  
         FROM events e2 
         WHERE e2.event_type = e.event_type  
         ORDER BY e2.time DESC 
         LIMIT 1 OFFSET 1) - 
        (SELECT e3.value  
         FROM events e3 
         WHERE e3.event_type = e.event_type  
         LIMIT 1)
    ) AS value
FROM events e
WHERE e.event_type IN (SELECT event_type
                       FROM events
                       GROUP BY event_type
                       HAVING COUNT(*) > 1)
ORDER BY e.event_type ASC;